(window.webpackJsonp=window.webpackJsonp||[]).push([[3],{"./src/replay/components/player/VideoStreamer/ShakaVideoStreamer/ShakaVideoStreamer.js":function(e,t,a){"use strict";a.r(t);var r=a("./src/replay/components/player/VideoStreamer/common/createVideoStreamerComponent.js"),n=a("./node_modules/shaka-player/dist/shaka-player.compiled.js"),i=a.n(n),s=a("./src/replay/components/player/VideoStreamer/types.js");const o=new Date(0);var c=(e,t,a)=>{const r=a&&a.liveEdgeMargin||10;return{adjustForDvrStartOffset:function(){if(e&&e.paused&&t.isLive()){const a=t.seekRange().start||0;a>=e.currentTime&&(e.currentTime=a+10)}},calculateNewState:function(){const a=t.seekRange(),n=t.isLive(),i=n?t.getPresentationStartTimeAsDate():new Date,s=e.currentTime-a.start,c=0!==a.end||0!==a.start?a.end-a.start:e.duration===1/0||isNaN(e.duration)?0:e.duration,l=function(e,t){return t?e===1/0||0===e||e<100?"live":"livedvr":"ondemand"}(c,n),u=n&&s>c-r,d=function(e,t,a,r){if(e){if(isNaN(t)){const e=new Date,t=new Date(e.getTime()-1e3*r);return{absolutePosition:e,absoluteStartPosition:t}}return{absolutePosition:new Date(t.getTime()+1e3*(r+a.start)),absoluteStartPosition:new Date(t.getTime()+1e3*a.start)}}return{absolutePosition:o,absoluteStartPosition:o}}(n,i,a,s);return{position:s,duration:c,playMode:l,isAtLiveEdge:u,absolutePosition:d.absolutePosition,absoluteStartPosition:d.absoluteStartPosition}},setPosition:function(a){isNaN(a)&&a===1/0||(e.currentTime=t.seekRange().start+a)},gotoLive:function(){t.isLive()&&(e.currentTime=t.seekRange().end)}}};const l={3016:function(e){return e.data&&e.data[0]&&3===e.data[0]?{classification:"STREAM_ERROR_DECODE"}:{classification:"STREAM_ERROR"}},4012:{classification:"STREAM_ERROR"},6001:{classification:"STREAM_ERROR_DRM_CLIENT_UNAVAILABLE"},6002:{classification:"STREAM_ERROR_DRM_CLIENT_UNAVAILABLE"},6003:{classification:"STREAM_ERROR"},6007:{classification:"STREAM_ERROR_DOWNLOAD"},6008:{classification:"STREAM_ERROR_DOWNLOAD"},6013:{classification:"STREAM_ERROR"},7e3:{classification:""},1:{classification:"STREAM_ERROR_DOWNLOAD"},2:{classification:"STREAM_ERROR_DECODE"},3:{classification:"STREAM_ERROR_DECODE"},4:{classification:"STREAM_ERROR_DECODE"},5:{classification:"STREAM_ERROR_DECODE"},6:{classification:"STREAM_ERROR_DECODE"}},u={classification:"STREAM_ERROR"};function d(e,t){return Object.keys(t).filter(a=>t[a]===parseInt(e,10))[0]}function f(e,t){if(1001===t.code&&t.data){if(t.data[0]&&/\.ttml|\.vtt|\.srt|subtitle/.test(t.data[0]))return"WARNING";if(502===t.data[1])return"FATAL"}return 4012===t.code||e&&t.code<2e3||2===t.category?"WARNING":"FATAL"}var g=function(e,t,a,r){if(t instanceof s.a)return t;const n=function(e){if(e.code){const t=l[e.code]||l[Math.floor(e.code/1e3)];return"function"===typeof t?t(e)||u:t||u}return u}(t).classification;if((t.message||"").indexOf("MediaSource")>=0)return new s.a("STREAM_ERROR_TECHNOLOGY_UNSUPPORTED","shaka","This browser does not support playing MPEG-DASH streams with Shaka Player.","FATAL",t);if(n){if("STREAM_ERROR_DRM_CLIENT_UNAVAILABLE"===n&&function(e,t){return t&&"http:"===t.protocol&&0!==t.hostname.indexOf("localhost")&&e&&e.indexOf("Edge")<0&&e.indexOf("Chrome")>0}(a,r)){const a="DRM playback is blocked in Chrome. Likely reason: This page is not served with HTTPS.";return new s.a("STREAM_ERROR","shaka",a,f(e,t),t)}return new s.a(n,"shaka",function(e,t){if(1001===e.code&&null!=e.data[1])return"Shaka request failed with status "+e.data[1]+" for URL "+e.data[0];if(1002===e.code)return"Shaka request could not be performed for URL "+e.data[0];if(1003===e.code)return"Shaka request timed out for URL "+e.data[0];if(e.message)return e.message;if("STREAM_ERROR_DRM_CLIENT_UNAVAILABLE"===t)return"Playback of protected content appears to be disabled in the browser.";if("STREAM_ERROR_DRM_OUTPUT_BLOCKED"===t)return"Playback of protected content appears to be disallowed, perhaps due to a non-secure or HDCP-less screen being connected.";const a=d(e.code,i.a.util.Error.Code),r="Shaka error "+d(e.category,i.a.util.Error.Category)+"/"+a+" reported";return e.data[0]?e.data[0].message?r+": "+e.data[0].message:r+". See the sourceError property for more details.":r+" with no further details."}(t,n),f(e,t),t)}return new s.a("STREAM_ERROR","shaka","Unknown error reported from Shaka Player.","WARNING",t)},p=a("./src/replay/components/player/VideoStreamer/common/sourceNormalizer.js");function k(e,t,a){const r=t.licenseUrl,n=t.licenseAcquisitionDetails||{},s=n.widevineServiceCertificateUrl||a&&a.licenseAcquisition&&a.licenseAcquisition.widevine&&a.licenseAcquisition.widevine.serviceCertificateUrl,o=function(e,t){return/Android(.*)Chrome/.test(e)?{audioRobustness:"SW_SECURE_CRYPTO",videoRobustness:"SW_SECURE_CRYPTO",serviceCertificate:t,_classification:"Android Chrome 58 and newer"}:{audioRobustness:"SW_SECURE_CRYPTO",videoRobustness:"SW_SECURE_DECODE",serviceCertificate:t,_classification:"Desktop"}}(navigator.userAgent,s),c=n.licenseRequestHeaders;return c&&Object.keys(c).length>0&&function(e,t){e.getNetworkingEngine().registerRequestFilter((e,a)=>{e===i.a.net.NetworkingEngine.RequestType.LICENSE&&Object.entries(t).forEach(([e,t])=>{a.headers[e]=t})})}(e,c),e.configure({drm:{servers:{"com.widevine.alpha":r,"com.microsoft.playready":r},advanced:{"com.widevine.alpha":{audioRobustness:o.audioRobustness,videoRobustness:o.videoRobustness,serverCertificate:o.serviceCertificate},"com.microsoft.playready":{videoRobustness:"SW_SECURE_DECODE",audioRobustness:"SW_SECURE_CRYPTO"}}}}),Promise.resolve()}var b=e=>(t,a)=>{const r=t.shakaRequestFilter,n=t.shakaResponseFilter,s=Object(p.a)(t.source);if(s)return function(e,t,a){const r=e.getNetworkingEngine();return r&&(r.clearAllRequestFilters(),r.clearAllResponseFilters(),t&&r.registerRequestFilter(t),a&&r.registerResponseFilter(a)),Promise.resolve()}(e,r,n).then(()=>k(e,s,t.configuration)).then(()=>e.load(s.streamUrl,s.startPosition)).catch(e=>{if(e&&e.code!==i.a.util.Error.Code.LOAD_INTERRUPTED)throw g(!1,e,navigator.userAgent,document.location)});if(a&&a.source){const t=e.getNetworkingEngine();return t.clearAllRequestFilters(),t.clearAllResponseFilters(),e.unload()}return Promise.resolve()},m=a("./src/replay/components/player/VideoStreamer/common/filteredStreamStateUpdater.js"),T=a("./src/replay/components/player/VideoStreamer/common/propertyApplier.js"),R=a("./src/replay/components/player/VideoStreamer/common/playbackLifeCycleManager.js"),h=a("./src/replay/components/player/VideoStreamer/BasicVideoStreamer/basicVideoEventHandlers.js");function E(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,r)}return a}function y(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}var S=({streamer:e,videoElement:t,shakaPlayer:a,streamRangeHelper:r,configuration:n,applyProperties:i,updateStreamState:s,log:o})=>{const c=Object(h.a)({streamer:e,videoElement:t,thirdPartyPlayer:a,streamRangeHelper:r,configuration:n,log:o,applyProperties:i,updateStreamState:s}),l=c.videoElementEventHandlers,u=c.pauseStreamRangeUpdater;let d={setStage:e=>{},getStage:()=>{}};const f={error:({detail:a})=>{o&&o("shaka.error");const r=g("started"===d.getStage(),a,navigator.userAgent,document.location);e.props.onPlaybackError&&e.props.onPlaybackError(r),t.error&&s({error:t.error}),"FATAL"===r.severity&&(d.setStage("dead"),s({playState:"inactive",isBuffering:!1,isSeeking:!1})),u.stop()},loading:()=>{if(o&&o("shaka.loading"),"new"===d.getStage()){if(d.setStage("starting"),e.props.initialPlaybackProps){const t=e.props.initialPlaybackProps,a=t.isMuted,r=t.volume;i({isMuted:a,volume:r})}s({playState:"starting",isBuffering:!0,volume:t.volume,isMuted:t.muted,isPipAvailable:c.isPipAvailable()})}},streaming:()=>{if(o&&o("shaka.streaming"),e.props.initialPlaybackProps){const a=e.props.initialPlaybackProps,r=a.isPaused,n=a.bitrateFix,o=a.bitrateCap;i({bitrateFix:n,bitrateCap:o}),r&&t.pause(),null==n&&s({bitrateFix:null}),null==o&&s({bitrateCap:null})}else s({bitrateFix:null,bitrateCap:null});s(function(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?E(Object(a),!0).forEach((function(t){y(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):E(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}({isMuted:t.muted,volume:t.volume},r.calculateNewState()))},buffering:({buffering:e})=>{o&&o("shaka.buffering."+e.toString()),e&&"started"===d.getStage()?s({isBuffering:e,playState:"buffering"}):s({isBuffering:e})}};return Object.entries(f).forEach(([e,t])=>{a.addEventListener(e,t)}),{videoElementEventHandlers:{onCanPlay:l.onCanPlay,onPlaying:l.onPlaying,onPause:l.onPause,onSeeking:l.onSeeking,onSeeked:l.onSeeked,onDurationChange:l.onDurationChange,onTimeUpdate:l.onTimeUpdate,onVolumeChange:l.onVolumeChange,onProgress:l.onProgress,onEnded:l.onEnded},pauseStreamRangeUpdater:u,setLifeCycleManager:function(e){d=e,c.setLifeCycleManager(e)},cleanup:function(){c.cleanup(),Object.entries(f).forEach(([e,t])=>{a.removeEventListener(e,t)})}}},v=a("./src/replay/components/player/VideoStreamer/common/renderers.js"),O=a("./src/replay/components/player/VideoStreamer/common/logger.js"),P=a("./src/replay/components/common.js");function A(e){return e&&e.bandwidth||0}function w(e,t){return e-t}function _(e,t){return e.bandwidth-t.bandwidth}function C(e){return e&&Math.ceil(e.bandwidth/1e3)||0}function x(e){return e&&e.active&&"variant"===e.type}function L(e,t,a){return a.indexOf(e)===t}const D={abr:{enabled:!0,restrictions:{maxBandwidth:1/0}}};var j=(e,t,a,r)=>{let n=[];function i(){let e=t.getVariantTracks();const r=C(e.filter(x)[0]),i=e.map(C).filter(L).sort(w),s={};r&&(s.currentBitrate=C(e.filter(x)[0])),Object(P.i)(n,i)||(n=i,s.bitrates=i),Object.keys(s).length>0&&a(s)}const s={loading:()=>{n=[]},streaming:i,adaptation:i,trackschanged:i};return Object.entries(s).forEach(([e,a])=>{t.addEventListener(e,a)}),{cleanup:function(){Object.entries(s).forEach(([e,a])=>{t.removeEventListener(e,a)})},fixBitrate:function(e){if("string"===typeof e)try{const n=t.getVariantTracks().slice(0).sort(_),i="min"===e?n[0]:"max"===e?n[n.length-1]:null;i?(t.configure({abr:{enabled:!1,restrictions:{maxBandwidth:1/0}}}),t.selectVariantTrack(i),a({bitrateFix:C(i)})):(t.configure(D),a({bitrateFix:null}),r&&r("Unknown string specified for bitrate lock. Please use a value of type number if a bitrate specified by kbps is intended.",e))}catch(n){t.configure(D),a({bitrateFix:null}),r&&r("Attempting to set "+e+"imum bitrate, but no tracks found. A bit too early, maybe?",t.getVariantTracks())}else if(isNaN(e)||null==e||e<0||!e)t.configure(D),a({bitrateFix:null}),r&&r("Resetting bitrate locking.");else{const n=t.getVariantTracks().filter((function(t){return C(t)===e}))[0];n?(t.configure({abr:{enabled:!1,restrictions:{maxBandwidth:1/0}}}),t.selectVariantTrack(n),a({bitrateFix:C(n)}),r&&r("Locking at bitrate "+e+".",n)):(t.configure(D),a({bitrateFix:null}),r&&r("Could not finding matching track for specified lock bitrate "+e+".",t.getVariantTracks()))}},capBitrate:function(e){if(isNaN(e)||e===1/0||null==e||e<0)r&&r("Resetting restrictions for bitrate."),t.configure(D),a({bitrateCap:null});else{const n=t.getVariantTracks().map(A).sort(w)[0];if(n){const i=Math.max(1e3*e,n),s={maxBandwidth:i};t.configure({abr:{enabled:!0,restrictions:s}}),a({bitrateCap:Math.ceil(i/1e3)}),s.maxBandwidth===n?r&&r("Applying restrictions for bitrate, but aligning to lowest available bitrate.",s):r&&r("Applying restrictions for bitrate.",s)}else r&&r("Bitrate range not found. Not safe to applying restrictions for bitrate.",t.getVariantTracks())}}}};const M=["id","language","kind","label"];function N(e,t){return e&&t&&M.filter(a=>function(e,t){return e===t||null==e&&null==t||Number.isNaN(e)&&Number.isNaN(t)}(e[a],t[a])).length===M.length||!e&&!t}function V(e,t,a){return{id:e,kind:"subtitle"===a.kind?"subtitles":a.kind||"",label:a.label||"",language:a.language||"",origin:t}}const U=["text/vtt","application/ttml+xml"];function B(e){const t=e.contentType;return t&&U.filter(e=>0===t.indexOf(e)).length>0}var F=function(e,t){let a=[],r=R.b;function n(){return(e.getTextTracks()||[]).filter(e=>e.active)[0]}function i(i){let s=null,o=null;try{o=e.isTextTrackVisible()?n():null}catch(c){}if(o){const e=a.filter(e=>!e.isBlacklisted&&null!=e.selectableTrack&&N(e.shakaTrack,o))[0];s=e?e.selectableTrack:null}if(i){const e=a.filter(e=>e.selectableTrack).map(e=>e.selectableTrack);Object(P.i)(e,r)?t({textTracks:r,currentTextTrack:s}):(r=e,t({textTracks:e,currentTextTrack:s}))}else t({currentTextTrack:s})}function s(){a.length=0,i(!0)}function o(t){const r=t.filter(B);return e.removeEventListener("trackschanged",l.trackschanged),function(e){const t=e.map(e=>{const t={id:null,sourceTrack:e.sourceTrack,shakaTrack:null,isBlacklisted:!1,isLoaded:!1,error:null,selectableTrack:null,shakaLoadPromise:e.addPromise.then(e=>(t.isLoaded=!0,t.shakaTrack=e,t.selectableTrack=V(e.id,"side-loaded",e),e),a=>(t.error=a||new Error("Shaka rejected adding a track with the URL "+e.sourceTrack.src),t.isBlacklisted=!0,t.isLoaded=!0,null))};return t});return a=a.concat(t),Promise.all(t.map(e=>e.shakaLoadPromise))}(r.filter(e=>{const t=a.filter(t=>t.sourceTrack&&t.sourceTrack.src===e.src&&t.shakaTrack);if(0===t.length)return!0;{const a=t[0];return!!a.shakaTrack&&(a.sourceTrack=e,a.isBlacklisted=!1,a.isLoaded=!0,a.shakaTrack&&(a.selectableTrack=V(a.shakaTrack.id,"side-loaded",a.shakaTrack)),a.error=null,a.loadPromise=Promise.resolve(),!1)}}).map(t=>{let a=t.contentType;const r=a?a.indexOf(";charset"):-1;return r>0&&(a=a&&a.substr(0,r)),{addPromise:e.addTextTrack(t.src,t.language,t.kind,a,null,t.label),sourceTrack:t}})).then(()=>{e.addEventListener("trackschanged",l.trackschanged),i(!0)})}function c(){const t=e.isTextTrackVisible()?n():null;a.filter(e=>null!=e.sourceTrack).forEach(a=>{a.selectableTrack&&(a.selectableTrack=null),t&&a.shakaTrack&&a.shakaTrack.active&&N(t,a.shakaTrack)&&e.setTextTrackVisibility(!1),a.isBlacklisted=!0})}const l={loading:s,trackschanged:function(){const t=e.getTextTracks()||[];if(0===t.length)s();else{const e=a.filter(e=>1===t.filter(t=>N(t,e.shakaTrack)).length),r=e.length<a.length;if(t.length>e.length){const r=t.filter(t=>0===e.filter(e=>N(t,e.shakaTrack)).length).map(e=>({sourceTrack:null,shakaTrack:e,isBlacklisted:!1,selectableTrack:V(e.id,"in-stream",e),isLoaded:!0,error:null}));a=e.concat(r),i(!0)}else r&&(a=e,i(!0))}},texttrackvisibility:()=>i(!1)};return Object.entries(l).forEach(([t,a])=>{e.addEventListener(t,a)}),{handleSelectedTextTrackChange:function(t){const r=t&&a.filter(e=>e.selectableTrack===t)[0];var n;(n=r&&r.shakaTrack)?(e.removeEventListener("texttrackvisibility",l.texttrackvisibility),e.isTextTrackVisible()||e.setTextTrackVisibility(!0),window.setTimeout(()=>{const t=(e.getTextTracks()||[]).filter(e=>N(e,n))[0];t?e.selectTextTrack(t):n&&e.selectTextTrack(n),i(!1),e.addEventListener("texttrackvisibility",l.texttrackvisibility)},1)):e.isTextTrackVisible()&&e.setTextTrackVisibility(!1)},handleTextTracksPropChange:function(e){c(),o(Array.isArray(e.textTracks)?e.textTracks:[])},handleSourcePropChange:function(e){let t=Array.isArray(e.textTracks)?e.textTracks:[];const a=Object(p.a)(e.source);a&&a.textTracks?o(t.concat(a.textTracks)):o(t)},clear:function(){c()},cleanup:function(){s(),Object.entries(l).forEach(([t,a])=>{e.removeEventListener(t,a)})}}};const H=({language:e,role:t},a)=>({selectableTrack:{id:e+t||a,kind:t,label:"",language:e,origin:"in-stream"},language:e,role:t});var q=(e,t)=>{let a=[];function r(){const r=e.getVariantTracks().filter(e=>e.active)[0],n=r&&a.filter(e=>((e,{language:t,role:a})=>e.language===t&&(!a||e.roles&&e.roles.indexOf(a)>=0))(r,e)).map(e=>e.selectableTrack)[0];t({currentAudioTrack:n})}function n(){a=e.getAudioLanguagesAndRoles().map(H);const n=a.map(e=>e.selectableTrack);t({audioTracks:n}),r()}const i={loading:n,trackschanged:n,adaptation:r};return Object.entries(i).forEach(([t,a])=>{e.addEventListener(t,a)}),{cleanup:function(){Object.entries(i).forEach(([t,a])=>{e.removeEventListener(t,a)})},handleSourceChange:function(){a.length=0},handleSelectedAudioTrackChange:function(t){const n=a.filter(e=>e.selectableTrack===t)[0];n&&(e.selectAudioLanguage(n.language,n.role),r())}}};const I=Object(r.a)("ShakaVideoStreamer",(function(e,t,a){let r;try{r=function(e,t){if(window.MediaSource&&MediaSource.isTypeSupported){const a=t&&t.shakaPlayer;a&&a.installPolyfills&&i.a.polyfill.installAll();const r=new i.a.Player(e);return a&&a.customConfiguration&&r.configure(a.customConfiguration),r}throw new s.a("STREAM_ERROR_TECHNOLOGY_UNSUPPORTED","shaka","MPEG-DASH playback with Shaka Player is not supported in this browser.")}(a,t)}catch(x){return Promise.reject(g(!1,x))}const n=c(a,r,t),o=b(r),l=Object(m.a)(e),u=F(r,l),d=q(r,l),f=j(e,r,l,Object(O.a)(window,"bitrateManager").log),p=Object(T.a)(a,n,u,d,f),k=Object(O.a)(window,"videoEvents").log,h=S({streamer:e,videoElement:a,shakaPlayer:r,streamRangeHelper:n,configuration:t,applyProperties:p,updateStreamState:l,log:k}),E=h.videoElementEventHandlers,y=h.setLifeCycleManager,P=Object(R.a)(l,h.pauseStreamRangeUpdater,Object(O.a)(window,"lifecycle").log);y(P);const A=P.startPlaybackSession,w=P.endPlaybackSession,_=r,C=v.a;return Promise.resolve({cleanup:function(){return u.cleanup(),d.cleanup(),P.cleanup(),h.cleanup(),f.cleanup(),function(e){return Promise.resolve(e&&e.destroy())}(r)},render:C,textTrackManager:u,audioTrackManager:d,thirdPartyPlayer:_,applyProperties:p,handleSourceChange:o,startPlaybackSession:A,endPlaybackSession:w,videoElementEventHandlers:E})}));t.default=I}}]);
//# sourceMappingURL=3.ff53f59f4d089ace5bd7.js.map