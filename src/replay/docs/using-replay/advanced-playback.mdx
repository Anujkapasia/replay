---
name: Advanced playback
route: /replay/advanced-playback
menu: 'Using the Replay player'
---

import { Playground, PropsTable } from 'docz';
import Replay from '../../default-player/Replay';
import HlsjsVideoStreamer from '../../components/player/VideoStreamer/HlsjsVideoStreamer/HlsjsVideoStreamer';
import ShakaVideoStreamer from '../../components/player/VideoStreamer/ShakaVideoStreamer/ShakaVideoStreamer';
import VideoStreamerResolver from '../../components/player/VideoStreamer/VideoStreamerResolver';
import '../../replay-default.css';

# Advanced playback topics

## Adaptive streaming support through third-party players

Adaptive streaming in Replay is supported through third party player integrations, namely several different `<*VideoStreamer/>` components included in the Replay package. Two of these integrate the most common and mature open source alternatives, HLS.js and Shaka Player. They correspondingly cover HLS and MPEG-DASH technologies (however the development appears to extend beyond the original target technology).

Unless DRM encryption is needed for the adaptive streams to be played with Replay, the best strategy is to have all streams in one of the formats (HLS and MPEG-DASH). Unencrypted either of these can play with the corresponding third party integration in all modern browsers.

If DRM playback must be supported, or if the different streams to be played have different formats, then Replay provides a helper component resolving what `VideoStreamer` covers playback. 

Examples of the different stream formats use case might be some DASH streams and MP4 files, or perhaps both HLS and DASH streams.

### Enabling playback for a single adaptive streaming technology

#### HLS with HLS.js

Add an import statement for the HLS.js video streamer component:

```javascript
import { Replay } from 'vimond-replay';
import 'vimond-replay/lib/index.css';
import HlsjsVideoStreamer from 'vimond-replay/lib/video-streamer/hlsjs';
```

Add the `<HlsjsVideoStreamer/>` component as the child of `<Replay/>`. This simply includes the HLS.js library through the VideoStreamer wrapping component.

<Playground>
  <Replay
    source="https://video-dev.github.io/streams/x36xhzz/x36xhzz.m3u8"
    initialPlaybackProps={{ isPaused: true }}>
    <HlsjsVideoStreamer/>
  </Replay>
</Playground>

Remember that the HLS.js library is actually playing the stream. Refer to the [project homepage](https://github.com/video-dev/hls.js/) for documentation on what's supported, troubleshooting playback, expected behaviour, etc.

Note that with this code, Replay's support for progressively downloaded MP4/WebM files is substituted, and such files are not supported.

If specific HLS.js configuration settings need to be set, they can be added like this:

```javascript
const replayOptions = {
  videoStreamer: {
    hlsjs: {
      customConfiguration: {
        capLevelToPlayerSize: true,
        maxBufferLength: 45
      }
    }
  }
};
// Pass this object to Replay as a configuration override:
const render = () => (
  <Replay
    source="https://video-dev.github.io/streams/x36xhzz/x36xhzz.m3u8"
    options={replayOptions}>
    <HlsjsVideoStreamer/>
  </Replay>
);
```

#### MPEG-DASH with Shaka Player

The Shaka Player video streamer component can be imported with the import statement added at the end:

```javascript
import { Replay } from 'vimond-replay';
import 'vimond-replay/lib/index.css';
import ShakaVideoStreamer from 'vimond-replay/lib/video-streamer/shaka-player';
```

Add the `<ShakaVideoStreamer/>` component as the child of `<Replay/>`. This simply includes the Shaka Player library through the VideoStreamer wrapping component.

<Playground>
  <Replay
    source="https://storage.googleapis.com/shaka-demo-assets/angel-one/dash.mpd"
    initialPlaybackProps={{ isPaused: true }}>
    <ShakaVideoStreamer/>
  </Replay>
</Playground>

Remember that Shaka Player is actually playing the stream. Refer to the [project homepage](https://github.com/google/shaka-player/) for documentation on what's supported, troubleshooting playback, expected behaviour, etc.

Note that with this code, Replay's support for progressively downloaded MP4/WebM files is substituted, and such files are not supported.

If specific Shaka Player configuration settings need to be set, they can be added like this:

```javascript
const replayOptions = {
  videoStreamer: {
    shaka: {
      customConfiguration: {
        streaming: {
          bufferingGoal: 120
        }
      }
    }
  }
};
// Pass this object to Replay as a configuration override:
const render = () => (
  <Replay
    source="https://storage.googleapis.com/shaka-demo-assets/angel-one/dash.mpd"
    options={replayOptions}>
    <ShakaVideoStreamer/>
  </Replay>
);
```

### Enabling playback for multiple streaming technologies based on stream technology resolution

The helper commponent `<VideoStreamerResolver/>`'s task is to select a compatible video streamer for Replay based on the stream type, and in a special case, the browser. 

For HLS, it inserts `<HlsjsVideoStreamer/>`, for MPEG-DASH `<ShakaVideoStreamer/>`. A progressive video source resolves to `<HtmlVideoStreamer/>`. The mentioned special case is the combination of Safari and HLS streams. Safari and the Apple operating systems support HLS natively, and the HTML video element play these streams optimally without any third party library. For this combination, the video streamer resolver then selects `<HtmlVideoStreamer/>`. It includes support for FairPlay DRM.

The stream type is resolved based on the source prop. The source prop should then ideally be an object containing the mime type associated with the resource specified by the stream URL. This is an example for HLS:

```javascript
const hlsSource = {
  streamUrl: 'https://video-dev.github.io/streams/x36xhzz/x36xhzz.m3u8',
  contentType: 'application/x-mpegurl'
};
```

The recognised mime types are as follows:

* MPEG-DASH: `application/dash+xml`
* HLS: `application/x-mpegurl`, alternatively `vnd.apple.mpegurl`
* Progressive MP4 or WebM: `video/mp4`, `video/webm`

If the source is only specified as a string containing the URL to the manifest, playlist, or video file, the video streamer resolver attempts detecting the stream type based on URL content.

```javascript
import React from 'react';
import { Replay } from 'vimond-replay';
import 'vimond-replay/lib/index.css';
import VideoStreamerResolver from 'vimond-replay/lib/video-streamer/resolver';
```

The following example resolves to inserting the HlsjsVideoStreamer for the specified source, unless this page is viewed in Safari, where HtmlVideoStreamer is selected.

<Playground>
  <Replay
    source={{
             streamUrl: 'https://video-dev.github.io/streams/x36xhzz/x36xhzz.m3u8',
             contentType: 'application/x-mpegurl'
           }}
    initialPlaybackProps={{ isPaused: true }}>
    <VideoStreamerResolver/>
  </Replay>
</Playground>

The following example selects the ShakaVideoStreamer for the specified source string. The manifest URL contains `.mpd`, which makes the video streamer resolver guess that this is a MPEG-DASH manifest.

<Playground>
  <Replay
    source="https://storage.googleapis.com/shaka-demo-assets/angel-one/dash.mpd"
    initialPlaybackProps={{ isPaused: true }}>
    <VideoStreamerResolver/>
  </Replay>
</Playground>

As for individual video streamer components, `<VideoStreamerResolver/>` should be inserted as `<Replay/>`'s child element. It renders the resolved video streamer component based on the source prop passed down from Replay.

Configuration for all video streamer components (inserted individually or through the video streamer resolver) can be specified in the same override object.

```javascript
const replayOptions = {
  videoStreamer: {
    hlsjs: {
      customConfiguration: {
        capLevelToPlayerSize: true,
        maxBufferLength: 45
      }
    },
    shaka: {
      customConfiguration: {
        streaming: {
          bufferingGoal: 120
        }
      }
    }
  }
};
```

## DRM

Every browser only supports one DRM technology. Because of the closed/black-box security model of DRM, browsers' DRM support cannot be exgtended. There are three relevant technologies for the modern browsers: 

* FairPlay: Only in Safari and with HLS streams
* PlayReady: MS Edge and Internet Explorer
* Widevine: Chrome on all platforms, Firefox

PlayReady and Widevine can typically be used with Shaka Player, and typically with MPEG-DASH. However both HLS.js and Shaka Player are implementing Widevine support for HLS streams as well.

This means that for covering all modern browsers with DRM encrypted playback, the following DRM services and stream formats must be available for one single content title:

* Acquisition URL for FairPlay license service, to be used with HLS streams encrypted for FairPlay.
* Acquisition URLs for a Widevine license service and a PlayReady license service, to be used with MPEG-DASH streams with common encryption (CENC).

According to the current browser, Replay must receive a source object specifying at least a license acquisition URL for the compatible DRM service, along with an URL to a stream encrypted for this DRM technology.

For the same content title, the source object could then look like this in the following browsers:

Firefox, Chrome:

```javascript
const source = {
  streamUrl: 'https://my-stream-cdn.net/my-content-title/stream.mpd',
  contentType: 'application/dash+xml',
  licenseUrl: 'https://my-license-service.com/widevine/license/my-content-title'
};
```

Edge:

```javascript
const source = {
  streamUrl: 'https://my-stream-cdn.net/my-content-title/stream.mpd',
  contentType: 'application/dash+xml',
  licenseUrl: 'https://my-license-service.com/playready/license/my-content-title'
};
```

Safari:

```javascript
const source = {
  streamUrl: 'https://my-stream-cdn.net/my-content-title/stream.m3u8',
  contentType: 'application/x-mpegurl',
  licenseUrl: 'https://my-license-service.com/fairplay/license/my-content-title',
  licenseAcquisitionDetails: {
    fairPlayCertificateUrl: 'https://my-license-service.com/fairplay/certificate'    
  }
};
```

Typically the `licenseAcquisitionDetails` source object needs more details specified in order to complete the license acquisition, most commonly authorization headers or token headers to be passed in the license request.

### Video streamer selection with DRM encrypted streams

The video streamer resolver or Replay does not cover matching of DRM technology with browser and stream technology.

When using Replay for DRM playback, the app inserting the player have the responsibility to pass the correct stream and DRM details as the source object to the Replay component. This typically involves detecting the browser, and then look up stream and DRM details from e.g. a REST API.

When the stream content type is specified, as in the examples above, the VideoStreamerResolver can be used for selecting the correct video streamer and third party library supporting the stream.

### Specifying further license acquisition or DRM details

#### Headers

Headers can be added to the license acqusition request, if required. They are specified with header names/values as keys/values, like in this example:

```javascript
const source = {
  streamUrl: 'https://my-stream-cdn.net/my-content-title/stream.mpd',
  contentType: 'application/dash+xml',
  licenseUrl: 'https://my-license-service.com/playready/license/my-content-title'
  licenseAcquisitionDetails: {
    licenseRequestHeaders: {
      Authorization: 'some-user-token',
      'x-some-custom-header': 'some-value'
    }    
  }
};
```

#### Certificates

In order to complete a FairPlay license acquisition, a certificate URL must always be specified. For Widevine, a similar URL can be passed. See the Safari example above for FairPlay, and the following for Widevine:

```javascript
const source = {
  streamUrl: 'https://my-stream-cdn.net/my-content-title/stream.mpd',
  contentType: 'application/dash+xml',
  licenseUrl: 'https://my-license-service.com/playready/license/my-content-title',
  licenseAcquisitionDetails: {
    widevineServiceCertificateUrl: 'https://my-license-service.com/widevine/certificate'      
  }
};
```

If no `widevineServiceCertificateUrl` is specified, the Widevine CDM reuses the license acquisition URL for fetching the service certificate.

The certificate URLs can also be specified as part of Replay's configuration.

#### FairPlay request formats and content IDs

The FairPlay license acquisition client in the `HtmlVideoStreamer` supports three request formats: `'base64'` (legacy), `'binary'`, and `'formdata'` (default). Different services expect different data and formats, and these three types adapt to some tested real-world services.

FairPlay's concept of content ID or asset ID can either be specified directly in the `contentId` property, or be extracted from the `skd://` url. 

If `contentIdExtractMatch` contains a regex (either regex object or string), what's matching in the skd url will be passed as the content ID in the license request. The commented out example underneath passes the full URL.

```javascript
const source = {
  streamUrl: 'https://my-stream-cdn.net/my-content-title/stream.m3u8',
  contentType: 'application/x-mpegurl',
  licenseUrl: 'https://my-license-service.com/fairplay/license/my-content-title',
  licenseAcquisitionDetails: {
    fairPlayCertificateUrl: 'https://my-license-service.com/fairplay/certificate',
    contentId: 'my-content-id', // Either specify the content ID, or how to extract it:
    // contentIdExtractMatch: /(.*)/
    fairPlayRequestFormat: 'base64' 
  }
};
```

The `contentIdExtractMatch` rule and FairPlay request format can also be specified as part of Replay's configuration.

## Subtitles and audio tracks

This chapter is not written yet, but will discuss what to expect from the APIs related to audio tracks and subtitle tracks.

## Bitrates and adaptive quality selection

This chapter is not written yet, but will discuss how an underlying adaptive streaming library's quality management is exposed in Replay.